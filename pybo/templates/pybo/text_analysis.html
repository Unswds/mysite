{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'style.css' %}">

<div class="container mt-5" style="max-width:900px;">
  <div class="card shadow p-4 fade-in-up">
    <h3 class="text-center mb-3">ğŸ“ í…ìŠ¤íŠ¸ ë¶„ì„</h3>

    <!-- ë‚¨ì€ íšŸìˆ˜ í‘œì‹œ -->
    <p class="text-end small text-muted mb-4">
      ì˜¤ëŠ˜ ë‚¨ì€ ë¶„ì„ íšŸìˆ˜: <strong>{{ remaining }}</strong> / 20
    </p>

    <!-- ë¶„ì„ ìš”ì²­ í¼ -->
    <form id="analysis-form" class="d-flex gap-2 mb-3">
      {% csrf_token %}
      <input
        id="sceneTxt"
        name="message"
        class="form-control flex-grow-1"
        placeholder="ë¶„ì„í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦"
        autocomplete="off"
        required
      >
      <button type="submit" class="btn btn-gradient flex-shrink-0">
        ìƒì„±
      </button>
    </form>

    <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
    <div id="status" class="small text-muted mb-2"></div>
    <img id="preview" class="img-fluid rounded shadow d-none" alt="generated image">
    <p id="prompt" class="mt-2 small fst-italic"></p>
  </div>
</div>

<script>
  (function(){
    const form      = document.getElementById('analysis-form');
    if (!form) return;

    const input     = document.getElementById('sceneTxt');
    const status    = document.getElementById('status');
    const preview   = document.getElementById('preview');
    const promptEl  = document.getElementById('prompt');
    const csrfToken = document.querySelector('#analysis-form [name=csrfmiddlewaretoken]').value;

    form.addEventListener('submit', e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      status.textContent    = 'â³ ë¶„ì„ì„ ìš”ì²­ ì¤‘â€¦';
      preview.classList.add('d-none');
      promptEl.textContent   = '';

      fetch("{% url 'pybo:analyze_text' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ message: text })
      })
      .then(res => res.json())
      .then(data => {
        if (data.url) {
          preview.src = data.url;
          preview.classList.remove('d-none');
          promptEl.textContent = 'Prompt: ' + data.prompt;
          status.textContent   = 'âœ… ì™„ë£Œ!';
        } else {
          status.textContent = 'âš ï¸ ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
      })
      .catch(() => {
        status.textContent = 'âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
      });
    });
  })();
</script>
{% endblock %}
