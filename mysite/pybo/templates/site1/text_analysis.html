{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'style.css' %}">

<div class="container mt-5" style="max-width:900px;">
  <div class="card shadow p-4 fade-in-up">
    <h3 class="text-center mb-3">ğŸ“í…ìŠ¤íŠ¸ ë¶„ì„</h3>

    <form id="imgForm" class="d-flex gap-2 mb-3">
      {% csrf_token %}
      <input id="sceneTxt" name="message" class="form-control flex-grow-1"
             placeholder="ì¥ë©´ì„ í•œê¸€ë¡œ ì…ë ¥í•˜ì„¸ìš”â€¦" autocomplete="off" required>
      <button class="btn btn-success flex-shrink-0">ìƒì„±</button>
    </form>

    <div id="status" class="small text-muted mb-2"></div>
    <img id="preview" class="img-fluid rounded shadow d-none" alt="generated image">
    <p id="prompt" class="mt-2 small fst-italic"></p>
  </div>
  
<!-- â”€â”€â”€â”€â”€ JS (ì´ë¯¸ì§€ ìƒì„±ìš©) â”€â”€â”€â”€â”€ -->
<script>
  (() => {
    const form   = document.getElementById('imgForm');
    if (!form) return;

    const input  = document.getElementById('sceneTxt');
    const imgEl  = document.getElementById('preview');
    const stat   = document.getElementById('status');
    const prompt = document.getElementById('prompt');
    const csrf   = document.querySelector('#imgForm [name=csrfmiddlewaretoken]').value;

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const txt = input.value.trim();
      if (!txt) return;

      stat.textContent = "â³ ê·¸ë¦¼ì„ ìƒì„± ì¤‘â€¦";
      imgEl.classList.add('d-none');
      prompt.textContent = "";

      fetch("{% url 'pybo:analyze_text' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrf,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ message: txt })
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.url) {
          imgEl.src = data.url;
          imgEl.classList.remove('d-none');
          prompt.textContent = "Prompt: " + data.prompt;
          stat.textContent = "âœ… ì™„ë£Œ!";
        } else {
          stat.textContent = "âš ï¸ " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
        }
      })
      .catch(() => stat.textContent = "âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
    });
  })();
</script>
{% endblock %}
